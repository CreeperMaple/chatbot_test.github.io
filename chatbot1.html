<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºåŒ—é¦¬æ‹‰æ¾ AI æ™ºæ…§å®¢æœ</title>
    <style>
        :root {
            --primary-color: #0969da;
            --bg-color: #f6f8fa;
            --user-bubble: #dcf8c6;
            --ai-bubble: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é ‚éƒ¨æ¨™é¡Œ */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* èŠå¤©å€åŸŸ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }

        /* ä½¿ç”¨è€…è¨Šæ¯æ¨£å¼ */
        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble);
            border-bottom-right-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* AI è¨Šæ¯æ¨£å¼ */
        .ai-message {
            align-self: flex-start;
            background-color: var(--ai-bubble);
            border-bottom-left-radius: 2px;
            border: 1px solid #e1e4e8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* è™•ç†å›å‚³çš„è¡¨æ ¼æ¨£å¼ */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        td {
            padding: 6px;
        }

        /* è¼¸å…¥å€åŸŸ */
        .input-area {
            background: white;
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        button:disabled {
            background-color: #ccc;
        }

        .loading {
            font-style: italic;
            color: #888;
            font-size: 0.8rem;
            margin-left: 5px;
        }
    </style>
</head>
<body>

    <div class="header">ğŸƒ è‡ºåŒ—é¦¬æ‹‰æ¾ AI å®¢æœåŠ©æ‰‹</div>

    <div id="chat-container">
        <!-- è¨Šæ¯æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        <div class="message ai-message">æ‚¨å¥½ï¼æˆ‘æ˜¯ 2025 è‡ºåŒ—é¦¬æ‹‰æ¾æ™ºæ…§å®¢æœï¼Œæœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ</div>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..." onkeypress="handleKeyPress(event)">
        <button id="send-btn" onclick="sendMessage()">ç™¼é€</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // å›ºå®šä¸€å€‹ sessionIdï¼Œæˆ–è€…æ˜¯éš¨æ©Ÿç”Ÿæˆä¸€å€‹
        const sessionId = "session_" + Math.floor(Math.random() * 10000);

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            appendMessage('user', text);
            userInput.value = '';
            
            // 2. é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            const loadingId = appendMessage('ai', '<span class="loading">æ€è€ƒä¸­...</span>');
            
            sendBtn.disabled = true;

            try {
                // 3. å‘¼å« Webhook
                // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ POSTï¼Œåƒæ•¸å¸¶åœ¨ URL ä¸Šï¼ˆå¦‚ä½ æˆªåœ–æ‰€ç¤ºï¼‰
                const webhookUrl = `https://n8n-service-dnng.onrender.com/webhook/taipei_marathon_AI_TEST?sessionId=${sessionId}&text=${encodeURIComponent(text)}&language=zh-TW&role=user`;

                const response = await fetch(webhookUrl, {
                    method: 'POST'
                });

                const data = await response.json();

                // 4. æ›´æ–° AI å›è¦†å…§å®¹ (è™•ç†å›å‚³çš„ HTML)
                updateMessage(loadingId, data.text || "æŠ±æ­‰ï¼Œæˆ‘æš«æ™‚ç„¡æ³•å›è¦†ã€‚");

            } catch (error) {
                console.error("Error:", error);
                updateMessage(loadingId, "é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        function appendMessage(role, content) {
            const id = 'msg-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}-message`;
            msgDiv.id = id;
            msgDiv.innerHTML = content; // ä½¿ç”¨ innerHTML å› ç‚ºå›å‚³å€¼åŒ…å« HTML æ¨™ç±¤
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            return id;
        }

        function updateMessage(id, newContent) {
            const msgDiv = document.getElementById(id);
            if (msgDiv) {
                msgDiv.innerHTML = newContent;
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>